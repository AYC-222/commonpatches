From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tri Vo <trong@google.com>
Date: Thu, 25 Jul 2019 16:57:16 -0700
Subject: ANDROID: xfrm: remove in_compat_syscall() checks
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This hack is needed to run 32-bit userspace on 64-bit kernel.

Bug: 138147164
Bug: 163141236
Test: kernel_net_tests
Change-Id: Ic7839c20e832781ac908d2779419d66e87e2b48c
Signed-off-by: Maciej Å»enczykowski <maze@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@google.com>
[ebiggers: folded v1 and v2 of this patch together]
Signed-off-by: Eric Biggers <ebiggers@google.com>
---
 net/xfrm/xfrm_state.c | 2 +-
 net/xfrm/xfrm_user.c  | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/net/xfrm/xfrm_state.c b/net/xfrm/xfrm_state.c
--- a/net/xfrm/xfrm_state.c
+++ b/net/xfrm/xfrm_state.c
@@ -2271,7 +2271,7 @@ int xfrm_user_policy(struct sock *sk, int optname, sockptr_t optval, int optlen)
 	struct xfrm_mgr *km;
 	struct xfrm_policy *pol = NULL;
 
-	if (in_compat_syscall())
+	if (!IS_ENABLED(CONFIG_ANDROID) && in_compat_syscall())
 		return -EOPNOTSUPP;
 
 	if (sockptr_is_null(optval) && !optlen) {
diff --git a/net/xfrm/xfrm_user.c b/net/xfrm/xfrm_user.c
--- a/net/xfrm/xfrm_user.c
+++ b/net/xfrm/xfrm_user.c
@@ -2642,7 +2642,7 @@ static int xfrm_user_rcv_msg(struct sk_buff *skb, struct nlmsghdr *nlh,
 	const struct xfrm_link *link;
 	int type, err;
 
-	if (in_compat_syscall())
+	if (!IS_ENABLED(CONFIG_ANDROID) && in_compat_syscall())
 		return -EOPNOTSUPP;
 
 	type = nlh->nlmsg_type;
